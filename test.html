<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Shop List</title>
    <link rel="shortcut icon" href="img/favicon.ico">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-social/4.10.1/bootstrap-social.min.css" />
    <!--<link rel="stylesheet" href="assets/style.css" />-->
    <style>
      body {
        margin: 10px;
        font-family: "Meiryo","Helvetica Neue",Helvetica,Arial,sans-serif;
      }
      .panel {
        transition: all 1s;
        animation-duration: 1s;
        animation-name: fade-in;
        animation-iteration-count: 1;
        animation-fill-mode: forwards;
        opacity: 0;
      }
      @keyframes fade-in {
        0% {
          opacity: 0.0;
        }
        50% {
          opacity: 0.4;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>

  <body>
    <div id="containerDOM"></div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/react/15.3.1/react.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/react/15.3.1/react-dom.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.30.3/react-bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>

    <!-- Load Leaflet from CDN-->
    <link rel="stylesheet" href="//unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet.css" />
    <script src="//unpkg.com/leaflet@1.0.0-rc.3/dist/leaflet-src.js"></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="//unpkg.com/esri-leaflet@2.0.3"></script>

    <!--[if lt IE 9]>
      <script>
        (function(){
          var ef = function(){};
          window.console = window.console || {log:ef,warn:ef,error:ef,dir:ef};
        }());
      </script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.2/html5shiv-printshiv.min.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/es5-shim/3.4.0/es5-shim.js"></script>
      <script src="//cdnjs.cloudflare.com/ajax/libs/es5-shim/3.4.0/es5-sham.js"></script>
    <![endif]-->

    <script type="text/babel">
      // React Bootstrap Components
      var Grid = ReactBootstrap.Grid;
      var Row = ReactBootstrap.Row;
      var Col = ReactBootstrap.Col;
      var Image = ReactBootstrap.Image;
      var Button = ReactBootstrap.Button;
      var Panel = ReactBootstrap.Panel;
      var Label = ReactBootstrap.Label;
      var Glyphicon = ReactBootstrap.Glyphicon;

      var bootstrapUtils = ReactBootstrap.utils.bootstrapUtils;

      // List Component
      var List = React.createClass({
        propTypes: {
          serviceUrl: React.PropTypes.string, // https://services.arcgis.com/wlVTGRSYTzAbjjiC/arcgis/rest/services/%E4%BF%9D%E8%82%B2%E5%9C%9223%E5%8C%BA/FeatureServer/0
          headerField: React.PropTypes.string, // '施設名'
          typeLabelField: React.PropTypes.string, // '種別'
          otherLabelFields: React.PropTypes.array, // ['対象年齢', '運営主体']
          mainInfoField: React.PropTypes.string, // ['定員']
          infoFields: React.PropTypes.array, // ['郵便番号', '住所']
          sortField: React.PropTypes.string, // ['定員']
          mapUrl: React.PropTypes.string
        },
        getDefaultProps: function() {
          return {
            serviceUrl: 'https://services.arcgis.com/wlVTGRSYTzAbjjiC/arcgis/rest/services/%E4%BF%9D%E8%82%B2%E5%9C%9223%E5%8C%BA/FeatureServer/0',
            headerField: '施設名',
            typeLabelField: '種別',
            otherLabelFields: ['対象年齢', '運営主体'],
            mainInfoField: ['定員'],
            infoFields: ['郵便番号', '住所'],
            sortField: ['定員'],
            mapUrl: 'https://bl.ocks.org/ynunokawa/raw/43ab2f03c4d2f29e3d5ebd3dadb1932d/'
          };
       },
        getInitialState() {
          return {
            data: [],
            relationship: 0, // 0: none, 1: within, 2: contains, 3: intersects, 4: overlap, 5: nearby
            geometry: null, // for Spatial Query
            latlng: [], // for Spatial Query (only nearby)
            distance: null, // for Spatial Query (only nearby)
            where: '1=0'
          }
        },
        componentDidMount() {
          window.onhashchange = function() {
            this.updateData();
          }.bind(this);
          this.updateData();

          // test script
          /*var testValue = 100;
          setInterval(function() {
            console.log('timer!');
            testValue = testValue + 100;
            location.hash = 'relationship=5&lat=35.73728805100046&lng=139.65429881300054&distance=' + testValue + '&where=1%3D1';
            console.log(location.hash);
          }, 5000);*/
        },
        updateData() {
          console.log('update!');
          var params = this.getQueryFromUrl();
          var query = L.esri.query({ url: this.props.serviceUrl });
          switch (params.relationship){
            case '0':
              break;
            case '1':
              query.within(params.geometry);
              break;
            case '2':
              query.contains(params.geometry);
              break;
            case '3':
              query.intersects(params.geometry);
              break;
            case '4':
              query.overlap(params.geometry);
              break;
            case '5':
              query.nearby(params.latlng, params.distance);
              break;
          }
          query.where(params.where);
          query.run(function (error, featureCollection, response) {
            console.log('Found ' + featureCollection.features.length + ' features');
            var sortField = this.props.sortField
            params.data = featureCollection.features.sort(function (a, b) {
              return b.properties[sortField] - a.properties[sortField];
            });
            this.setState(params);
          }, this);
        },
        getQueryFromUrl() {
          var params = {
            data: [],
            relationship: 0, // 0: none, 1: within, 2: contains, 3: intersects, 4: overlap, 5: nearby
            geometry: null, // for Spatial Query
            latlng: [], // for Spatial Query (only nearby)
            distance: null, // for Spatial Query (only nearby)
            where: '1=0'
          };
          var urlParams = location.hash.substring(1).split('&');
            for (var i=0; urlParams[i]; i++) {
              var param = urlParams[i].split('=');
              if(param[0] === 'relationship') {
                params.relationship = param[1];
              }
              if(param[0] === 'geometry') {
                params.geometry = param[1];
              }
              if(param[0] === 'lat') {
                params.latlng[0] = param[1];
              }
              if(param[0] === 'lng') {
                params.latlng[1] = param[1];
              }
              if(param[0] === 'distance') {
                params.distance = param[1];
              }
              if(param[0] === 'where') {
                params.where = decodeURIComponent(param[1]);
              }
           }
           return params;
        },
        showMap(e) {
          location.href = this.props.mapUrl + '?name=' + e.target.title;
        },
        showGoogle(e) {
          location.href = 'https://www.google.co.jp/#q=' + e.target.title;
        },
        render() {
          bootstrapUtils.addStyle(Panel, 'custom');
          bootstrapUtils.addStyle(Button, 'custom');

          var listItems = this.state.data.map(function (f) {
            var title = f.properties[this.props.headerField];
            var geometry = f.geometry.coordinates;
            var typeLabel = f.properties[this.props.typeLabelField];
            var info = f.properties[this.props.mainInfoField];

            var otherLabel = this.props.otherLabelFields.map(function (field) {
              var label = f.properties[field];
              return (
                <Label>{label}</Label>&nbsp;
              );
            });

            var subcontents = this.props.infoFields.map(function (infoField) {
              var info = f.properties[infoField];
              return (
                <p className="list-panel-subcontents">{infoField}: {info}</p>
              );
            });

            var contentsLayout = (
              <Row>
                <style type="text/css">{`
                  .list-panel-thumbnail {
                      width: 100%;
                      margin-bottom: 10px;
                      border: 1px solid #ddd;
                  }
                  .list-panel-subcontents {
                      font-size: .8em;
                  }
                `}</style>
                <Col xs={6} md={6}>
                  <Label bsStyle="info">{typeLabel}</Label>&nbsp;
                  {otherLabel}
                  <h3>{this.props.mainInfoField}: {info}</h3>
                  {subcontents}
                </Col>
                <Col xs={6} md={6}>
                  <Image src="https://react-bootstrap.github.io/assets/thumbnail.png" className="list-panel-thumbnail" thumbnail />
                </Col>
              </Row>
            );

            return (
              <Col xs={12} sm={6} md={4}>
                <style type="text/css">{`
                .panel-custom {
                    border-color: #f5646a;
                }
                .panel-custom > .panel-heading {
                    background-color: #f5646a;
                    color: #fff;
                    border-color: #f5646a;
                    font-weight: bold;
                }
                .btn-custom {
                    color: #fff;
                    background-color: #f58264;
                    border-color: #f58264;
                }
                `}</style>
                <Panel header={title} bsStyle="custom" key={title}>
                  {contentsLayout}
                  <style type="text/css">{`
                  .list-panel-footer {
                      text-align: right;
                  }
                  `}</style>
                  <Row>
                    <Col xs={12} md={12} className="list-panel-footer">
                      <Button title={title} onClick={this.showMap} bsStyle="custom">マップ <Glyphicon glyph="map-marker" /></Button>&nbsp;
                      <Button title={title} onClick={this.showGoogle}>Google 検索</Button>
                    </Col>
                  </Row>
                </Panel>
              </Col>
            );
          }, this);

          return (
            <Grid>
            <Row>
            {listItems}
            </Row>
            </Grid>
          )
        }
      });

      ReactDOM.render(<List />, document.getElementById("containerDOM"));
    </script>
  </body>
</html>